{% extends "base.html" %}
{% load gear_filters %}

{% block title %}
Edit Collection
{% endblock %}

{% block content %}
<div class="container mx-auto max-w-4xl p-6">
  <h1 class="text-3xl font-semibold mb-6">Edit Collection</h1>

  <form method="POST" enctype="multipart/form-data" class="space-y-6 disable-on-submit">
    {% csrf_token %}

    {{ form.non_field_errors }}

    <div class="space-y-4">
      {{ form.title }}

      {{ form.description }}

      {% if is_librarian %}
        <div class="flex items-center space-x-2">
          {{ form.is_private }}
          <label for="{{ form.is_private.id_for_label }}" class="text-gray-700">Private Collection</label>
        </div>
      {% endif %}

      <div class="space-y-2">
        <label for="{{ form.image.id_for_label }}" class="block text-lg font-medium text-gray-700 mb-2">
          Upload New Image
        </label>
        {{ form.image }}
        {{ form.image.errors }}

        {% if collection.image %}
          <div class="mt-4">
            <p class="font-semibold">Current Image:</p>
            <div class="flex flex-wrap gap-2">
              <img src="{{ collection.image.url }}" alt="Collection image" class="w-24 h-24 object-cover rounded border" />
            </div>
          </div>
        {% endif %}
    </div>
    
      
    </div>

    <div id="allowed-users-container" style="display: none;">
      <label class="block text-lg font-medium text-gray-700 mb-4">Allowed Users</label>

      <div class="border border-neutral-100 bg-neutral-100 p-4 rounded-xl mb-4">
        <div class="mb-4">
          {% include 'components/_search.html' with placeholder='Search librarians...' class='w-25' id='librarian-search' no_form=True on_search='filterCards.bind(null, ".user-card")' %}
        </div>

        <div id="librarians-container" class="max-h-72 overflow-y-auto pb-4">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            {% for user in form.allowed_users.field.queryset %}
              <div class="user-card flex items-center p-3 bg-base-100 shadow rounded-lg cursor-pointer hover:shadow-lg transition-all duration-200">
                <input type="checkbox"
                       name="allowed_users"
                       value="{{ user.id }}"
                       {% if user in form.initial.allowed_users or user in form.data.allowed_users %}checked{% endif %}
                       id="user_{{ user.id }}"
                       class="hidden" />

                <div class="flex items-center w-full">
                  <div class="flex-shrink-0">
                    <img src="{{ user.profile_picture.url }}" alt="{{ user.name }}" class="w-10 h-10 rounded-full object-cover border border-gray-200" />
                  </div>
                  <div class="ml-3 flex-grow">
                    <p class="text-sm font-medium text-gray-900">{{ user.name }}</p>
                    <p class="text-xs text-gray-500">{{ user.email }}</p>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    
    <!-- Items -->
    <label class="block text-lg font-medium text-gray-700 mb-2">Choose Items</label>
    <div class="border border-neutral-100 bg-neutral-100 p-4 rounded-xl mb-4">
      <div class="mb-4">
        {% include 'components/_search.html' with placeholder='Search items...' class='w-25' id='item-search' no_form=True on_search='filterCards.bind(null, ".item-card")' %}
      </div>
      <div id="items-container" class="max-h-72 overflow-y-auto pb-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          {% for item in form.items.field.queryset %}
        
            <div class="item-card relative group bg-base-100 shadow rounded-lg p-4 flex items-center {% if item.in_private_collection and item not in form.initial.items %}opacity-50 cursor-not-allowed{% else %}hover:shadow-lg cursor-pointer{% endif %}"   data-in-public="{{ item.in_public_collection|yesno:'true,false' }}">
                                 
              <input type="checkbox" name="items" value="{{ item.id }}" {% if item in form.initial.items or item in form.data.items %}checked{% endif %} {% if item.in_private_collection and item not in form.initial.items %}disabled{% endif %} id="item_{{ item.id }}" class="hidden"/>
            
              <div class="flex items-center w-full">
                <div class="flex-shrink-0">
                  <img src="{{ item.get_first_image }}" alt="{{ item.title }}" class="w-10 h-10 rounded-full object-cover border border-gray-200" />
                </div>
                <div class="ml-3 flex-grow">
                  <p class="text-sm font-medium text-gray-900">{{ item.title }}</p>
                  <p class="text-xs text-gray-500">{{ item.description }}</p>
                </div>
              </div>
            </div>
            {% endfor %}

          </div>
        </div>
      </div>
      <div class="flex justify-end">
        <button type="submit" data-disable-on-submit class="flex btn btn-success text-lg">Save Changes <i
            class="bi bi-save ml-2"></i></button>
      </div>
    </div>
  </form>
</div>


<input type="checkbox" id="confirm-modal" class="modal-toggle" />
  <div class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg">Confirm Private Collection</h3>
      <p id="confirm-modal-message" class="py-4"></p>
      <div class="modal-action">
        <button type="button" id="modal-cancel" class="btn">Cancel</button>
        <button id="modal-confirm" class="btn btn-primary">Confirm<i class="bi bi-hand-thumbs-up"></i></button>
      </div>
    </div>
  </div>
  
<script>
  let debounceTimeout;

  function debounce(func, wait) {
    return function (...args) {
      clearTimeout(debounceTimeout);
      debounceTimeout = setTimeout(() => func(...args), wait);
    }
  }

  function updateCardStyles(card) {
    const checkbox = card.querySelector('input[type="checkbox"]');
    const nameElement = card.querySelector('.text-sm');
    const descriptionElement = card.querySelector('.text-xs');

    if (checkbox.checked) {
      card.classList.add('bg-primary', 'text-white');
      card.classList.remove('bg-base-100');
      nameElement.classList.remove('text-gray-900');
      nameElement.classList.add('text-white');
      descriptionElement.classList.remove('text-gray-500');
      descriptionElement.classList.add('text-white');
    } else {
      card.classList.remove('bg-primary', 'text-white');
      card.classList.add('bg-base-100');
      nameElement.classList.remove('text-white');
      nameElement.classList.add('text-gray-900');
      descriptionElement.classList.remove('text-white');
      descriptionElement.classList.add('text-gray-500');
    }
  }

  function filterCards(selector, query) {
    const cards = document.querySelectorAll(selector);
    const searchQuery = query.toLowerCase().trim();
    let hasVisibleCards = false;

    cards.forEach((card) => {
      const name = card.querySelector('.text-sm').textContent.toLowerCase();
      const desc = card.querySelector('.text-xs').textContent.toLowerCase();

      if (name.includes(searchQuery) || desc.includes(searchQuery)) {
        card.style.display = 'flex';
        hasVisibleCards = true;
      } else {
        card.style.display = 'none';
      }
    });

    const container = document.querySelector(`${selector.includes("user") ? "#librarians-container .grid" : "#items-container .grid"}`);
    const existingMessage = container.querySelector('.no-results');

    if (!hasVisibleCards) {
      if (!existingMessage) {
        const message = document.createElement('p');
        message.className = 'no-results text-gray-500 text-center py-8 col-span-2';
        message.textContent = selector.includes("user") ? 'No librarians found.' : 'No items found.';
        container.appendChild(message);
      }
    } else if (existingMessage) {
      existingMessage.remove();
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.user-card, .item-card').forEach((card) => {
      card.addEventListener('click', () => {
        const checkbox = card.querySelector('input[type="checkbox"]');
        // check if checkbox is disabled
        if (checkbox.disabled) {
          return
        }
        checkbox.checked = !checkbox.checked;
        updateCardStyles(card);
      });
      
      const checkbox = card.querySelector('input[type="checkbox"]')
      if (checkbox.checked) {
        updateCardStyles(card)
      }
    });

    const librarianSearchInput = document.getElementById('librarian-search');
    if (librarianSearchInput) {
      librarianSearchInput.addEventListener('input', debounce((e) => {
        filterCards('.user-card', e.target.value);
      }, 300));
    }

    const itemSearchInput = document.getElementById('item-search');
    itemSearchInput.addEventListener('input', debounce((e) => {
      filterCards('.item-card', e.target.value);
    }, 300));

    const privateCheckbox = document.querySelector('input[name="is_private"]');
    const allowedUsersContainer = document.getElementById('allowed-users-container');

    if (privateCheckbox && allowedUsersContainer) {
      function toggleAllowedUsers() {
        allowedUsersContainer.style.display = privateCheckbox.checked ? 'block' : 'none';
      }
      toggleAllowedUsers();
      privateCheckbox.addEventListener('change', toggleAllowedUsers);
    }
  });

  document.addEventListener('DOMContentLoaded', function () {
    const form = document.querySelector('form.disable-on-submit')
    const privateCheckbox = form.querySelector('input[name="is_private"]')
    const modalToggle = document.getElementById('confirm-modal')
    const modalMessage = document.getElementById('confirm-modal-message')
    const modalCancel = document.getElementById('modal-cancel')
    const modalConfirm = document.getElementById('modal-confirm')
  
    modalCancel.addEventListener('click', () => {
      modalToggle.checked = false
  
      const submitButton = form.querySelector('[data-disable-on-submit]')
      if (submitButton) {
        submitButton.disabled = false
        submitButton.classList.remove('opacity-50', 'cursor-not-allowed')
        submitButton.innerHTML = 'Submit <i class="bi bi-send-plus-fill ml-2"></i>'
      }
    })
  
    form.addEventListener('submit', (e) => {
      if (!privateCheckbox.checked) return
      const publicSelected = Array.from(document.querySelectorAll('.item-card[data-in-public="true"]')).filter((card) => card.querySelector('input[type="checkbox"]').checked)
      if (!publicSelected.length) return
      e.preventDefault()
      const names = publicSelected.map((c) => c.querySelector('.text-sm').textContent)
      modalMessage.textContent = `Are you sure you want to make this collection private with “${names.join('”, “')}”? This will remove them from all other public collections they belong to.`
      modalToggle.checked = true
    })
  
    modalConfirm.addEventListener('click', () => {
      modalToggle.checked = false
      form.submit()
    })
  })
</script>
{% endblock %}