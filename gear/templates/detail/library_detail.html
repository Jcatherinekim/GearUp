{% extends 'base.html' %}
{% load gear_filters %}

{% block title %}
  Library Details
{% endblock %}

{% block content %}
  <div class="max-w-6xl mx-auto px-4 py-8 space-y-8">
    <h1 class="text-2xl font-bold text-gray-700 mb-4">Library Details</h1>
    <div class="bg-base-100 rounded-xl shadow-md p-6 border border-gray-200">
      {% if library.image %}
        <div class="flex justify-center mb-6">
          <img src="{{ library.image.url }}" alt="Library image" class="max-w-xs max-h-48 object-cover rounded-lg" />
        </div>
      {% endif %}
      <div class="flex flex-col md:flex-row items-center md:items-start space-y-4 md:space-y-0 md:space-x-6 mb-4">
        <div class="w-full md:text-left">
          <h2 class="text-3xl font-bold text-primary mb-2">{{ library.title }}</h2>
          <p class="text-gray-700">{{ library.description }}</p>
          {% if library.created_at %}
            <p class="text-sm text-gray-500">Created on: {{ library.created_at|date:'M d, Y' }}</p>
          {% endif %}
        </div>
      </div>
      <div class="text-sm text-gray-500 flex items-center justify-between">
        <div class="flex items-center">
          <i class="bi bi-person-circle mr-1 text-primary"></i>
          Created by GearUp
        </div>
        {% if request.user.is_authenticated and user_is_librarian %}
          <div class="flex space-x-2">
            <a href="{% url 'gear:edit_library' library.id %}" class="btn btn-warning text-lg">Edit<i class="bi bi-pencil-square ml-1"></i></a>
            <button class="btn btn-error text-lg" onclick="my_modal_3.showModal()">Delete<i class="bi bi-trash ml-1"></i></button>
            <dialog id="my_modal_3" class="modal">
              <div class="modal-box">
                <form method="dialog">
                  <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
                </form>
                <h3 class="font-bold text-lg">Delete "{{ library.title }}"?</h3>
                <p class="py-4 text-gray-600">This action is permanent and cannot be undone.</p>
                <form action="{% url 'gear:delete_library' library.id %}" method="POST">
                  {% csrf_token %}
                  <div class="modal-action">
                    <button type="button" class="btn btn-outline" onclick="my_modal_3.close()">Cancel</button>
                    <button type="submit" class="btn btn-error">Yes, Delete<i class="bi bi-trash"></i></button>
                  </div>
                </form>
              </div>
            </dialog>
          </div>
        {% endif %}
      </div>
    </div>

    <div class="mt-8">
      <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
        <h2 class="text-xl font-semibold">Collections & Items</h2>
        <div class="flex items-center gap-2">
          <div class="btn-group" id="filter-buttons">
            <button data-filter="all"
              class="btn {% if current_filter == 'all' %}
                
                
                
                
                
                
                btn-primary






              {% else %}
                
                
                
                
                
                
                btn-outline






              {% endif %}">
              All
            </button>
            <button data-filter="collections"
              class="btn {% if current_filter == 'collections' %}
                
                
                
                
                
                
                btn-primary






              {% else %}
                
                
                
                
                
                
                btn-outline






              {% endif %}">
              Collections
            </button>
            <button data-filter="items"
              class="btn {% if current_filter == 'items' %}
                
                
                
                
                
                
                btn-primary






              {% else %}
                
                
                
                
                
                
                btn-outline






              {% endif %}">
              Items
            </button>
          </div>
          <div class="w-72">
            {% include 'components/_search.html' with placeholder='Search...' class='w-full' id='library-content-search' no_form=True on_search='filterLibraryContent' %}
          </div>
        </div>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        {% for collection in collections %}
          <div class="collection-card scale-95 transform">
            {% include 'components/_collection_card.html' with collection=collection %}
          </div>
        {% endfor %}

        {% for item in items %}
          <div class="item-card scale-95 transform">
            {% include 'components/_item_card.html' with item=item %}
          </div>
        {% endfor %}

        {% if not collections and not items %}
          <p class="text-gray-500 col-span-full text-center py-8">
            No collections or items found{% if content_search_query %} matching your search{% endif %}.
          </p>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    let debounceTimeout
    let activeFilter = '{{ current_filter }}' || 'all'
    
    function debounce(func, wait) {
      return function (...args) {
        clearTimeout(debounceTimeout)
        debounceTimeout = setTimeout(() => func(...args), wait)
      }
    }
    
    function filterLibraryContent(query) {
      const collectionCards = document.querySelectorAll('.collection-card')
      const itemCards = document.querySelectorAll('.item-card')
      const searchQuery = query.toLowerCase().trim()
      let hasVisibleContent = false
    
      function checkCardContent(card) {
        const titleElement = card.querySelector('.card-title')
        const descriptionElement = card.querySelector('.text-xs, .text-sm:not(.card-title)')
    
        if (!titleElement) return false
    
        const title = titleElement.textContent.toLowerCase()
        const description = descriptionElement ? descriptionElement.textContent.toLowerCase() : ''
    
        return title.includes(searchQuery) || description.includes(searchQuery)
      }
    
      collectionCards.forEach((card) => {
        const isMatch = checkCardContent(card)
    
        if (isMatch && (activeFilter === 'all' || activeFilter === 'collections')) {
          card.style.display = 'block'
          hasVisibleContent = true
        } else {
          card.style.display = 'none'
        }
      })
    
      itemCards.forEach((card) => {
        const isMatch = checkCardContent(card)
    
        if (isMatch && (activeFilter === 'all' || activeFilter === 'items')) {
          card.style.display = 'block'
          hasVisibleContent = true
        } else {
          card.style.display = 'none'
        }
      })
    
      const container = document.querySelector('.grid')
      let existingMessage = document.querySelector('.no-results-message')
    
      if (!hasVisibleContent) {
        if (!existingMessage) {
          const message = document.createElement('p')
          message.className = 'no-results-message text-gray-500 col-span-full text-center py-8'
          message.textContent = 'No collections or items found matching your search.'
          container.appendChild(message)
        }
      } else if (existingMessage) {
        existingMessage.remove()
      }
    }
    
    function applyFilter(filterType) {
      activeFilter = filterType
    
      const buttons = document.querySelectorAll('#filter-buttons button')
      buttons.forEach((btn) => {
        if (btn.dataset.filter === filterType) {
          btn.classList.add('btn-primary')
          btn.classList.remove('btn-outline')
        } else {
          btn.classList.remove('btn-primary')
          btn.classList.add('btn-outline')
        }
      })
    
      const collectionCards = document.querySelectorAll('.collection-card')
      const itemCards = document.querySelectorAll('.item-card')
    
      if (filterType === 'all' || filterType === 'collections') {
        collectionCards.forEach((card) => {
          card.style.display = 'block'
        })
      } else {
        collectionCards.forEach((card) => {
          card.style.display = 'none'
        })
      }
    
      if (filterType === 'all' || filterType === 'items') {
        itemCards.forEach((card) => {
          card.style.display = 'block'
        })
      } else {
        itemCards.forEach((card) => {
          card.style.display = 'none'
        })
      }
    
      const searchInput = document.getElementById('library-content-search')
      if (searchInput && searchInput.value.trim() !== '') {
        filterLibraryContent(searchInput.value)
      }
    
      const container = document.querySelector('.grid')
      let existingMessage = document.querySelector('.no-results-message')
    
      const hasVisibleContent = [...collectionCards, ...itemCards].some((card) => card.style.display !== 'none')
    
      if (!hasVisibleContent) {
        if (!existingMessage) {
          const message = document.createElement('p')
          message.className = 'no-results-message text-gray-500 col-span-full text-center py-8'
          message.textContent = 'No collections or items found.'
          container.appendChild(message)
        }
      } else if (existingMessage) {
        existingMessage.remove()
      }
    }
    
    document.addEventListener('DOMContentLoaded', function () {
      const searchInput = document.getElementById('library-content-search')
      if (searchInput) {
        searchInput.addEventListener(
          'input',
          debounce((e) => {
            filterLibraryContent(e.target.value)
          }, 300)
        )
    
        if (searchInput.value) {
          filterLibraryContent(searchInput.value)
        }
      }
    
      document.querySelectorAll('#filter-buttons button').forEach((button) => {
        button.addEventListener('click', function (e) {
          e.preventDefault()
          applyFilter(this.dataset.filter)
        })
      })
    
      applyFilter(activeFilter)
    })
  </script>
{% endblock %}
