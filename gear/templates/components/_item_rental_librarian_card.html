{% load static %}
{% load tz %}
<div class="relative card bg-base-100 rounded-xl overflow-hidden shadow-xl hover:shadow-2xl transition-all duration-300 flex flex-col h-full">
  <a href="{% url 'gear:item_detail' request.item.id %}" class="flex-grow">
    <figure class="aspect-[4/3] bg-gray-100 overflow-hidden relative flex items-center justify-center">
      <img src="{{ request.item.get_first_image }}" alt="{{ request.item.title }}" class="max-w-full max-h-full object-contain" />
      <div class="absolute top-4 left-4">
        {% if request.status == 'pending' %}
          <span class="badge badge-warning text-xs font-medium">Pending</span>
        {% elif request.status == 'approved' %}
          <span class="badge badge-success text-xs font-medium">Approved</span>
        {% elif request.status == 'rejected' %}
          <span class="badge badge-error text-xs font-medium">Denied</span>
        {% endif %}
      </div>
    </figure>
    <div class="card-body p-6 flex flex-col justify-between">
      <div>
        <div class="flex justify-between items-start mb-2">
          <div class="badge badge-outline text-xs font-bold text-success border-emerald-200">Rental Request</div>
          <div class="text-sm text-gray-500">{{ request.request_date|localtime|date:'M d, Y g:i A' }}</div>
        </div>
        <h2 class="card-title text-lg font-bold mb-2">{{ request.item.title }}</h2>
        <p class="text-sm text-gray-600 mb-1">Patron: {{ request.patron.name }}</p>
        <p class="text-sm text-gray-600 mb-3">Quantity: {{ request.quantity }}</p>

        {% if request.status == 'approved' %}
          <p class="text-sm text-success">
            <i class="bi bi-check-circle mr-1"></i>Approved on: {{ request.approved_date|date:'M d, Y' }}
          </p>
          <p class="text-sm text-gray-600">Approved by: {{ request.approved_by.name }}</p>
        {% elif request.status == 'rejected' %}
          <p class="text-sm text-error">
            <i class="bi bi-x-circle mr-1"></i>Denied on: {{ request.request_date|localtime|date:'M d, Y g:i A' }}
          </p>
          <p class="text-sm text-gray-600">Denied by: {{ request.approved_by.name }}</p>
        {% endif %}
      </div>
    </div>
  </a>

  {% if request.status == 'pending' %}
    <div class="card-actions justify-end p-4 border-t border-gray-100">
      <label for="approve-modal-{{ request.id }}" class="btn bg-white text-success border-success btn-sm hover:text-white hover:bg-success">Approve <i class="bi bi-hand-thumbs-up"></i></label>
      <label for="deny-modal-{{ request.id }}" class="btn bg-white text-error border-error btn-sm hover:text-white hover:bg-error">Deny <i class="bi bi-hand-thumbs-down"></i></label>
    </div>

    <input type="checkbox" id="approve-modal-{{ request.id }}" class="modal-toggle" />
    <div class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg">Approve Rental Request</h3>
        <p class="py-4">Are you sure you want to approve the request for {{ request.quantity }} {{ request.item.title }} by {{ request.patron.name }}?</p>
        <p class="text-sm text-gray-600">
          Available quantity: {{ request.item.available_quantity }}
          {% if request.quantity > request.item.available_quantity %}
            <span class="text-error">(Not enough available)</span>
          {% endif %}
        </p>
        <div class="modal-action">
          <label for="approve-modal-{{ request.id }}" class="btn btn-outline">Cancel</label>
          <form method="POST" action="{% url 'users:approve_rental_request' request.id %}" class="approve-request-form disable-on-submit">
            {% csrf_token %}
            <button data-disable-on-submit type="submit" class="btn bg-white text-success border-success hover:text-white hover:bg-success">Approve Request<i class="bi bi-hand-thumbs-up"></i></button>
          </form>
        </div>
      </div>
      <label class="modal-backdrop" for="approve-modal-{{ request.id }}"></label>
    </div>

    <input type="checkbox" id="deny-modal-{{ request.id }}" class="modal-toggle" />
    <div class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg">Deny Rental Request</h3>
        <p class="py-4">Are you sure you want to deny the request for {{ request.quantity }} {{ request.item.title }} by {{ request.patron.name }}?</p>
        <div class="modal-action">
          <label for="deny-modal-{{ request.id }}" class="btn btn-outline">Cancel</label>
          <form method="POST" action="{% url 'users:deny_rental_request' request.id %}" class="deny-request-form disable-on-submit">
            {% csrf_token %}
            <button data-disable-on-submit type="submit" class="btn bg-red-500 text-white hover:bg-red-600">Deny Request<i class="bi bi-hand-thumbs-down"></i></button>
          </form>
        </div>
      </div>
      <label class="modal-backdrop" for="deny-modal-{{ request.id }}"></label>
    </div>
  {% endif %}
</div>
